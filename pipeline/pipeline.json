{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "gitHubToken": {
      "Type": "String",
      "NoEcho": "true"
    }
  },
  "Resources": {
    "pipeline": {
      "Type": "AWS::CodePipeline::Pipeline",
      "Properties": {
        "Name" : "Project",
        "Stages": [
          {
            "Name": "Sources",
            "Actions": [
              {
                "Name": "Update",
                "ActionTypeId": {
                  "Category": "Source",
                  "Owner": "ThirdParty",
                  "Version": "1",
                  "Provider": "GitHub"
                },
                "Configuration": {
                  "Owner": "jumal",
                  "Repo": "aws-continuous-delivery-demo-app",
                  "Branch": "master",
                  "OAuthToken": {
                    "Ref": "gitHubToken"
                  }
                },
                "OutputArtifacts": [
                  {
                    "Name": "sources"
                  }
                ]
              }
            ]
          },
          {
            "Name": "Build",
            "Actions": [
              {
                "Name": "Compile",
                "InputArtifacts": [
                  {
                    "Name": "sources"
                  }
                ],
                "ActionTypeId": {
                  "Category": "Build",
                  "Owner": "Custom",
                  "Version": "5",
                  "Provider": "project-jenkins"
                },
                "Configuration": {
                  "ProjectName": "compile"
                },
                "OutputArtifacts": [
                  {
                    "Name": "build"
                  }
                ]
              },
              {
                "Name": "Test",
                "InputArtifacts": [
                  {
                    "Name": "build"
                  }
                ],
                "ActionTypeId": {
                  "Category": "Test",
                  "Owner": "Custom",
                  "Version": "5",
                  "Provider": "project-jenkins"
                },
                "Configuration": {
                  "ProjectName": "test"
                },
                "RunOrder": 2
              },
              {
                "Name": "Analyse",
                "InputArtifacts": [
                  {
                    "Name": "build"
                  }
                ],
                "ActionTypeId": {
                  "Category": "Test",
                  "Owner": "Custom",
                  "Version": "5",
                  "Provider": "project-jenkins"
                },
                "Configuration": {
                  "ProjectName": "analyse"
                },
                "RunOrder": 3
              }
            ]
          },
          {
            "Name": "QA",
            "Actions": [
              {
                "Name": "Package",
                "InputArtifacts": [
                  {
                    "Name": "build"
                  }
                ],
                "ActionTypeId": {
                  "Category": "Build",
                  "Owner": "Custom",
                  "Version": "5",
                  "Provider": "project-jenkins"
                },
                "Configuration": {
                  "ProjectName": "package"
                },
                "OutputArtifacts": [
                  {
                    "Name": "package"
                  }
                ]
              },
              {
                "Name": "Deploy",
                "InputArtifacts": [
                  {
                    "Name": "package"
                  }
                ],
                "ActionTypeId": {
                  "Category": "Test",
                  "Owner": "Custom",
                  "Version": "5",
                  "Provider": "project-jenkins"
                },
                "Configuration": {
                  "ProjectName": "deploy-to-qa"
                },
                "RunOrder": 2
              }
            ]
          },
          {
            "Name": "Production",
            "Actions": [
              {
                "Name": "Deploy",
                "InputArtifacts": [
                  {
                    "Name": "package"
                  }
                ],
                "ActionTypeId": {
                  "Category": "Test",
                  "Owner": "Custom",
                  "Version": "5",
                  "Provider": "project-jenkins"
                },
                "Configuration": {
                  "ProjectName": "deploy-to-production"
                }
              }
            ]
          }
        ],
        "DisableInboundStageTransitions" : [
          {
            "pipelineName": "Project",
            "stageName": "Production",
            "transitionType": "Inbound",
            "reason": "Manual transition to production"
          }
        ],
        "ArtifactStore": {
          "Type": "S3",
          "Location": {
            "Ref": "artifactStore"
          }
        },
        "RoleArn": {
          "Fn::GetAtt": [
            "role",
            "Arn"
          ]
        }
      }
    },
    "artifactStore": {
      "Type": "AWS::S3::Bucket"
    },
    "role": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "codepipeline.amazonaws.com"
                ]
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonS3FullAccess"
        ],
        "Path": "/"
      }
    }
  }
}
